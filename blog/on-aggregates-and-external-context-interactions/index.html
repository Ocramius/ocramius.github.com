<!DOCTYPE html>
<html>
    <head>
        <title>On Aggregates and Domain Service interaction</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="A practical example of how DDD Aggregates can talk to the external world without the need to &quot;know&quot; about their domain services upfront">
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/font/stylesheet.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/css/menu_bubble.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/normalize.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/demo.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/font-awesome-4.2.0/css/font-awesome.min.css" />
        <link href="https://ocramius.github.io/img/marco-pivetta-ocramius.gif" rel="shortcut icon"/>
        <link rel="stylesheet" href="https://ocramius.github.io/components/highlightjs/styles/github.css" />
        <link href="https://ocramius.github.io/css/style.css" rel="stylesheet" type="text/css" />
        <link rel="alternate" type="application/atom+xml" href="https://ocramius.github.io/atom.xml" title=" activity feed" />
    </head>
    <script src="https://ocramius.github.io/js/snap.svg-min.js"></script>
    <body>
        <div class="container">

            <div class='menu-wrap'>
                <nav class="menu">
                    <div class="icon-list">
                        <a href="https://ocramius.github.io/"><i class="fa fa-fw fa-newspaper-o"></i><span>Latest Posts</span></a>
                        <a href="https://ocramius.github.io/blog"><i class="fa fa-fw fa-comment-o"></i><span>Archive</span></a>
                        <a href="https://ocramius.github.io/talks"><i class="fa fa-fw fa-youtube"></i><span>Presentations</span></a>
                        <a href="https://ocramius.github.io/joindin"><i class="fa fa-fw fa-star-o"></i><span>Talks</span></a>
                        <a href="https://ocramius.github.io/about"><i class="fa fa-fw fa-user"></i><span>About</span></a>                        <a href="https://twitter.com/Ocramius" rel="me" title="Ocramius twitter profile" target="_blank"><i class="fa fa-fw fa-twitter"></i><span>Twitter</span></a>                        <a href="https://github.com/Ocramius" rel="me" title="Ocramius github profile" target="_blank"><i class="fa fa-fw fa-github"></i><span>Github</span></a>                    </div>
                </nav>                <button class="close-button" id="close-button">Close Menu</button>                <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                        <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
                    </svg>
                </div>
            </div>            <button class="menu-button" id="open-button">Open Menu</button>
            <div class="content-wrap">
                <div class="content">
                    <div class="top left">
                        <p id="shield-container" class="logo-cont left" style="width: 200px; padding: 0; margin: 0; height: 200px;
"></p>                        <h2 class="left text-center">Marco Pivetta <span>(<a href="//twitter.com/Ocramius" target="blank">Ocramius</a>)</span></h2>                    </div>

                    <div class="clear"></div>
                    <p class="text-center remove-margin">
                        <img src="https://ocramius.github.io/img/separator.png" alt=""/>
                    </p>
                    <div class="row-fluid">
                        <div class="span12">    <article>
        <header>
            <h1>On Aggregates and Domain Service interaction</h1>
        </header>
        <div><p>
    Some time ago, I was asked where I put I/O operations when dealing with
    aggregates.
</p>

<div data-tweet-id="808545609468801024" class="twitter-tweet"></div>

<p>
    The context was a <abbr title="command query responsibility segregation">CQRS</abbr>
    and Event Sourced architecture, but in general, the approach that I prefer also applies to most
    imperative ORM entity code (assuming a proper data-mapper is involved).
</p>

<h3>Scenario</h3>

<p>
    Let's use a practical example:
</p>

<pre><code class="gherkin">Feature: credit card payment for a shopping cart checkout

  Scenario: a user must be able to check out a shopping cart
    Given the user has added some products to their shopping cart
    When the user checks out the shopping cart with their credit card
    Then the user was charged for the shopping cart total price

  Scenario: a user must not be able to check out an empty shopping cart
    When the user checks out the shopping cart with their credit card
    Then the user was not charged

  Scenario: a user cannot check out an already purchased shopping cart
    Given the user has added some products to their shopping cart
    And the user has checked out the shopping cart with their credit card
    When the user checks out the shopping cart with their credit card
    Then the user was not charged
</code></pre>

<p>
    The scenario is quite generic, but you should be able to see what the application is supposed to do.
</p>

<h3>An initial implementation</h3>

<p>
    I will take an imperative command + domain-events approach, but we don't need to
    dig into the patterns behind it, as it is quite simple.
</p>

<p>
    We are looking at a command like following:
</p>

<pre><code class="php">final class CheckOutShoppingCart
{
    public static function from(
        CreditCardCharge $charge,
        ShoppingCartId $shoppingCart
    ) : self {
        // ...
    }

    public function charge() : CreditCardCharge { /* ... */ }
    public function shoppingCart() : ShoppingCartId { /* ... */ }
}
</code></pre>

<p>
    If you are unfamiliar with what a
    <abbr title="A command is a value object that encapsulates the intent and parameters of our business interaction">command</abbr>
    is, it is just the object that our frontend or API throws at our actual
    application logic.
</p>

<p>
    Then there is an aggregate performing the actual domain logic work:
</p>

<pre><code class="php">final class ShoppingCart
{
    // ... 

    public function checkOut(CapturedCreditCardCharge $charge) : void
    {
        $this-&gt;charge = $charge;

        $this-&gt;raisedEvents[] = ShoppingCartCheckedOut::from(
            $this-&gt;id,
            $this-&gt;charge
        );
    }

    // ... 
}
</code></pre>

<p>
    If you are unfamiliar with what an <i>aggregate</i> is,
    it is the direct object in our interaction (look at the
    sentences in the scenario).
    In your existing applications, it would most likely (but not exclusively)
    be an entity or a DB record or group of entities/DB records that you
    are considering during a business interaction.
</p>

<p>
    We need to glue this all together with a command handler:
</p>

<pre><code class="php">final class HandleCheckOutShoppingCart
{
    public function __construct(Carts $carts, PaymentGateway $gateway)
    {
        $this-&gt;carts   = $carts;
        $this-&gt;gateway = $gateway;
    }

    public function __invoke(CheckOutShoppingCart $command) : void
    {
        $shoppingCart = $this-&gt;carts-&gt;get($command-&gt;shoppingCart());

        $payment = $this-&gt;gateway-&gt;captureCharge($command-&gt;charge());

        $shoppingCart-&gt;checkOut($payment);
    }
}
</code></pre>

<p>
    This covers the "happy path" of our workflow, but we still lack:
</p>

<ul>
    <li>The ability to check whether the payment has already occurred</li>
    <li>Preventing payment for empty shopping carts</li>
    <li>Preventing payment of an incorrect amount</li>
    <li>Handling of critical failures on the payment gateway</li>
</ul>

<p>
    In order to do that, we have to add some "guards" that prevent the interaction.
    This is the approach that I've seen being used in the wild:
</p>

<pre><code class="php">final class HandleCheckOutShoppingCart
{
    // ... 

    public function __invoke(CheckOutShoppingCart $command) : void
    {
        $cartId = $command-&gt;shoppingCart();
        $charge = $command-&gt;charge();

        $shoppingCart = $this-&gt;carts-&gt;get($cartId);

        // these guards are injected callables. They throw exceptions:
        ($this-&gt;nonEmptyShoppingCart)($cartId);
        ($this-&gt;nonPurchasedShoppingCart)($cartId);
        ($this-&gt;paymentAmountMatches)($cartId, $charge-&gt;amount());

        $payment = $this-&gt;gateway-&gt;captureCharge($charge);

        $shoppingCart-&gt;checkOut($payment);
    }
}
</code></pre>

<p>
    As you can see, we are adding some logic to our command handler here.
    This is usually done because dependency injection on the command handler
    is easy.
    
    Passing services to the aggregate via dependency injection is generally
    problematic and to be avoided, since an aggregate is usually a 
    <a href="http://misko.hevery.com/2008/09/30/to-new-or-not-to-new/" target="_blank">"newable type"</a>.
</p>

<p>
    With this code, we are able to handle most unhappy paths, and eventually
    also failures of the payment gateway (not in this article).
</p>

<h3>The problem</h3>

<p>
    While the code above works, what we did is adding some domain-specific logic
    to the command handler. Since the command handler is part of our application
    layer, we are effectively diluting these checks into "less important layers". 
</p>

<p>
    In addition to that, the command handler is required in tests
    that consume the above specification: without the command handler, our logic
    will fail to handle the unhappy paths in our scenarios.
</p>

<p>
    For those that are reading and practice CQRS+<abbr title="Event Sourcing">ES</abbr>:
    you also know that those guards aren't always simple to implement!
    Read models, projections... Oh my!
</p>

<p>
    Also: what if we wanted to react to those failures, rather than just stop
    execution? Who is responsible or that?
</p>

<p>
    If you went with the <abbr title="test driven development">TDD</abbr> way, then
    you already saw all of this coming: let's fix it!
</p>

<h3>Moving domain logic back into the domain</h3>

<p>
    What we did is putting logic from the domain layer (which should be in the aggregate)
    into the application layer: let's turn around and put domain logic in the domain (reads:
    in the aggregate logic).
</p>

<p>
    Since we don't really want to inject a payment gateway as a constituent part
    of our aggregate root (a newable shouldn't have non-newable depencencies),
    we just borrow a brutally simple concept from functional programming:
    we pass the <abbr
    title="An interactor is just an object to which we delegate some work. In this case, a service">interactor</abbr>
    as a method parameter.
</p>

<pre><code class="php">final class ShoppingCart
{
    // ... 

    public function checkOut(
        CheckOutShoppingCart $checkOut,
        PaymentGateway $paymentGateway
    ) : void {
        $charge = $checkOut-&gt;charge();

        Assert::null($this-&gt;payment, 'Already purchased');
        Assert::greaterThan(0, $this-&gt;totalAmount, 'Price invalid');
        Assert::same($this-&gt;totalAmount, $charge-&gt;amount());

        $this-&gt;charge = $paymentGateway-&gt;captureCharge($charge);

        $this-&gt;raisedEvents[] = ShoppingCartCheckedOut::from(
            $this-&gt;id,
            $this-&gt;charge
        );
    }

    // ... 
}
</code></pre>

<p>
    The command handler is also massively simplified, since all it
    does is forwarding the required dependencies to the aggregate:
</p>

<pre><code class="php">final class HandleCheckOutShoppingCart
{
    // ... 

    public function __invoke(CheckOutShoppingCart $command) : void
    {
        $this
            -&gt;shoppingCarts
            -&gt;get($command-&gt;shoppingCart())
            -&gt;checkOut($command, $this-&gt;gateway);
    }
}
</code></pre>

<h3>Conclusions</h3>

<p>
    Besides getting rid of the command handler in the scenario tests, here
    is a list of advantages of what we just implemented:
</p>

<ol>
    <li>
        The domain logic is all in one place, easy to read and easy to change.
    </li>
    <li>
        We can run the domain without infrastructure code (note: the payment gateway is a
        domain service)
    </li>
    <li>
        We can prevent invalid interactions to happen without having to push verification
        data across multiple layers
    </li>
    <li>
        Our aggregate is now able to fullfill its main role: being a domain-specific state machine,
        preventing invalid state mutations.
    </li>
    <li>
        If something goes wrong, then the aggregate is able to revert state mutations.
    </li>
    <li>
        We can raise domain events on failures, or execute custom domain logic.
    </li>
</ol>

<p>
    The approach described here fits any kind of application where there
    is a concept of <abbr title="an object with an assigned identifier">Entity</abbr> or Aggregate.
    Feel free to stuff your entity API with business logic!
</p>

<p>
    Just remember that entities should only be self-aware, and only context-aware
    in the context of certain business interactions: don't inject or statically
    access domain services from within an entity.
</p>
        </div>            <p class="tags">
            Tags:            <a href="https://ocramius.github.io/blog/tags/php">php</a>,            <a href="https://ocramius.github.io/blog/tags/ddd">ddd</a>,            <a href="https://ocramius.github.io/blog/tags/cqrs">cqrs</a>,            <a href="https://ocramius.github.io/blog/tags/event%20sourcing">event sourcing</a>,            <a href="https://ocramius.github.io/blog/tags/aggregate">aggregate</a>,            <a href="https://ocramius.github.io/blog/tags/aggregate%20root">aggregate root</a>,            <a href="https://ocramius.github.io/blog/tags/patterns">patterns</a>,            <a href="https://ocramius.github.io/blog/tags/clean%20code">clean code</a>            </p>            <nav class="article">
                <ul>                        <li>Next: <a class="next" href="https://ocramius.github.io/blog/yubikey-for-ssh-gpg-git-and-local-login" title="YubiKey for SSH, Login, 2FA, GPG and Git Signing"><span class="title">YubiKey for SSH, Login, 2FA, GPG and Git Signing</span></a></li>                        <li>Previous: <a class="previous" href="https://ocramius.github.io/blog/proxy-manager-2-0-0-release" title="ProxyManager 2.0.0 release and expected 2.x lifetime"><span class="title">ProxyManager 2.0.0 release and expected 2.x lifetime</span></a></li>                </ul>
            </nav>        </article>        <div data-tweet-id="824352805318250504" class="twitter-tweet"></div>        
        <div id="disqus_thread"></div>

        <script>
            if (typeof prettyPrint !== 'undefined') {
                $(prettyPrint);
            }
        </script>
        <script>
            var disqus_shortname = 'ocramius-dev';
            var disqus_identifier = '/blog/on-aggregates-and-external-context-interactions';
            var disqus_url = 'https://ocramius.github.io/blog/on-aggregates-and-external-context-interactions';
        </script>
        <script src="https://ocramius-dev.disqus.com/count.js"></script>
        <script src="https://ocramius-dev.disqus.com/embed.js"></script>                        </div>
                        <div class="span4 si debar"></div>
                   </div>
                </div>
            </div>

        </div>

        <script src="https://ocramius.github.io/js/shifty.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r66/three.min.js"></script>
        <script src="https://ocramius.github.io/components/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://ocramius.github.io/components/jquery/jquery.min.js"></script>
        <script src ="https://ocramius.github.io/js/blogpost-tweets.js" type="text/javascript"></script>
        <script src="https://platform.twitter.com/widgets.js"></script>        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-33922165-1', 'auto');
            ga('send', 'pageview');
        </script>
        <script src="https://ocramius.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script src="https://ocramius.github.io/js/classie.js"></script>
        <script src="https://ocramius.github.io/js/main4.js"></script>
        <script src="https://ocramius.github.io/js/three-js-object-loader.js"></script>
        <script src="https://ocramius.github.io/js/mario.js"></script>
        <script>mario($('#shield-container'), "https://ocramius.github.io/logo/mario");</script>
    </body>
</html>
