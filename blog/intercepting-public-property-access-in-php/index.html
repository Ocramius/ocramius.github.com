<!DOCTYPE html>
<html>
    <head>
        <title>Property Accessors in PHP Userland</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="description" content="A simple technique to use PHP&#039;s OOP implementation to intercept access to object public properties">
        
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/font/stylesheet.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/css/menu_bubble.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/normalize.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/demo.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/fontawesome.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/brands.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/solid.min.css" />
        <link href="https://ocramius.github.io/img/marco-pivetta-ocramius.gif" rel="shortcut icon"/>
        <link rel="stylesheet" href="https://ocramius.github.io/components/highlightjs/styles/github.css" />
        <link href="https://ocramius.github.io/css/style.css" rel="stylesheet" type="text/css" />
        <link rel="alternate" type="application/atom+xml" href="https://ocramius.github.io/atom.xml" title=" activity feed" />
    </head>
    <script src="https://ocramius.github.io/js/snap.svg-min.js"></script>
    <body>
        <div class="container">

            <div class='menu-wrap display'>
                <nav class="menu">
                    <div class="icon-list">
                        <a href="https://ocramius.github.io/"><i class="fa fa-solid fa-newspaper"></i><span>Latest Posts</span></a>
                        <a href="https://ocramius.github.io/blog"><i class="fa fa-solid fa-comment"></i><span>Archive</span></a>
                        <a href="https://ocramius.github.io/talks"><i class="fa fa-brands fa-youtube"></i><span>Presentations</span></a>
                        <a href="https://ocramius.github.io/joindin"><i class="fa fa-solid fa-star"></i><span>Talks</span></a>
                        <a href="https://ocramius.github.io/about"><i class="fa fa-solid fa-user"></i><span>About</span></a>

                                                <a href="https://mastodon.social/@ocramius" rel="me" title="https://mastodon.social/@ocramius mastodon profile" target="_blank"><i class="fa fa-brands fa-mastodon"></i><span>Mastodon</span></a>
                        
                                                <a href="https://github.com/Ocramius" rel="me" title="Ocramius github profile" target="_blank"><i class="fa fa-brands fa-github"></i><span>Github</span></a>
                                            </div>
                </nav>
                                <button class="close-button" id="close-button">Close Menu</button>
                                <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                        <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
                    </svg>
                </div>
            </div>

                        <button class="menu-button" id="open-button">Open Menu</button>
            
            <div class="content-wrap">
                <div class="content">
                    <div class="top left">
                        <p id="shield-container" class="logo-cont left" style="width: 200px; padding: 0; margin: 0; height: 200px;
"></p>
                                                <h2 class="left text-center">Marco Pivetta <span>(<a href="https://mastodon.social/@ocramius" target="blank">Ocramius</a>)</span></h2>
                                            </div>

                    <div class="clear"></div>
                    <p class="text-center remove-margin">
                        <img src="https://ocramius.github.io/img/separator.png" alt=""/>
                    </p>
                    <div class="row-fluid">
                        <div class="span12">
                                <article>
        <header>
            <h1>Property Accessors in PHP Userland</h1>
        </header>
        <div>
            <p>
    Some time ago many people were disappointed by the fact that
    <a href="https://wiki.php.net/rfc/propertygetsetsyntax-v1.2" target="_blank">PHP wasn't going to have
    property accessors</a>, which are a very cool feature and would have helped a lot in reducing
    boilerplate code in a lot of applications and frameworks.
</p>

<p>
    Last October I learned from
    <a href="https://twitter.com/lsmith" target="_blank">Lukas Smith</a>
    about a trick that he used to discover when a public property of an object was being accessed.
    <br/>
    He mainly used the trick that I'm going to show to handle lazy-loading within
    <a href="https://github.com/doctrine/phpcr-odm" target="_blank">PHPCR ODM</a>.
</p>

<p>
    The trick basically allows to implement property accessors in userland code by exploiting how PHP
    handles object properties internally.
</p>

<p>
    I never got back to writing a blogpost about it, but here it finally is!
</p>

<p>
    Here's a very simple example:
</p>

<pre><code class="php">&lt;?php

class Foo
{
    public $publicProperty = 'baz';
}
</code></pre>

<p>
    What we want is some way to know whenever somebody writes or reads property <code>$publicProperty</code>
    from our object.
</p>

<p>
    In order to do so, we can use a simple wrapper for our <code>Foo</code> object. Because we want to
    respect the <a title="Liskov Substitution Principle" href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank">LSP</a>,
    we have this wrapper extending <code>Foo</code>:
</p>

<pre><code class="php">&lt;?php

class FooWrapper extends Foo
{
    public function __construct()
    {
        unset($this-&gt;publicProperty);
    }
}
</code></pre>

<p>
    That's it so far! Let's try it out:
</p>

<pre><code class="php">&lt;?php

$foo = new FooWrapper();

echo $foo-&gt;publicProperty;
</code></pre>

<p>
    Weirdly, this <a href="https://3v4l.org/gRtoj" target="_blank">will produce</a>
    something like following:
</p>

<pre class="prettyprint linenums">Notice: Undefined property: FooWrapper::$publicProperty in [...]</pre>

<p>
    That basically means the property was not just set to <code>NULL</code>, but completely removed!
</p>

<p>
    Let's use this at our own advantage by tweaking <code>FooWrapper</code> a bit:
</p>

<pre><code class="php">&lt;?php

class FooWrapper extends Foo
{
    private $wrapped;

    public function __construct(Foo $wrapped)
    {
        $this-&gt;wrapped = $wrapped;

        unset($this-&gt;publicProperty);
    }

    public function __get($name)
    {
        echo 'Getting property ' . $name . PHP_EOL;

        return $this-&gt;wrapped-&gt;$name;
    }

    public function __set($name, $value)
    {
        echo 'Setting property ' . $name . ' to ' . $value . PHP_EOL;

        return $this-&gt;wrapped-&gt;$name = $value;
    }
}
</code></pre>

<p>
    And here again, let us try it out:
</p>

<pre><code class="php">&lt;?php

$foo = new FooWrapper(new Foo());

echo $foo-&gt;publicProperty;
echo PHP_EOL;
echo $foo-&gt;publicProperty = 'test';
</code></pre>

<p>
    This <a href="https://3v4l.org/mmMZU" target="_blank">will produce</a> following output:
</p>

<pre><code class="sh">Getting property publicProperty
baz
Setting property publicProperty to test
test
</code></pre>

<p>
    Cool, huh? And the same works with <code>__isset</code> and <code>__unset</code> too!
</p>

<p>
    This doesn't really replace property accessors, but it gives us a way of protecting access to public
    properties via composition, inheritance and a bit of hacking.
</p>

<p>
    There's not many use cases for this right now, since you have to write a lot of boilerplate code for
    it to work correctly.
</p>

<p>
    It is worth mentioning that this logic has been used to make
    <a href="http://doctrine-project.org/" target="_blank">Doctrine 2.4</a> even more awesome.
    I also wrote a component called
    <a href="https://github.com/Ocramius/ProxyManager" target="_blank">ProxyManager</a>,
    which avoids you from writing all the boilerplate code over and over again, so check it out!
</p>

<p>
    Here's how the code from before rewritten using ProxyManager 0.4:
</p>

<pre><code class="php">&lt;?php

use ProxyManager\Configuration;
use ProxyManager\Factory\AccessInterceptorValueHolderFactory as Factory;

require_once __DIR__ . '/vendor/autoload.php';

class Foo
{
    public $publicProperty = 'baz';
}

$config  = new Configuration();
$factory = new Factory($config);

$foo = $factory-&gt;createProxy(
    new Foo(),
    array(
        '__get' =&gt; function ($proxy, $instance, $method, $params) {
            echo 'Getting property ' . $params['name'] . PHP_EOL;
        },
        '__set' =&gt; function ($proxy, $instance, $method, $params) {
            echo 'Setting property ' . $params['name'] . ' to ' . $params['value'] . PHP_EOL;
        }
    )
);

echo $foo-&gt;publicProperty;
echo PHP_EOL;
echo $foo-&gt;publicProperty = 'test';
</code></pre>

<p>
    Give it a try and drop me a line if you like it or hate it!
</p>

        </div>
                            <p class="tags">
            Tags:
                        <a href="https://ocramius.github.io/blog/tags/php">php</a>,                         <a href="https://ocramius.github.io/blog/tags/oop">oop</a>,                         <a href="https://ocramius.github.io/blog/tags/access">access</a>,                         <a href="https://ocramius.github.io/blog/tags/property%20accessors">property accessors</a>                        </p>
        
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="https://ocramius.github.io/blog/accessing-private-php-class-members-without-reflection/" title="Accessing private PHP class members without reflection"><span class="title">Accessing private PHP class members without reflection</span></a></li>
                                                                <li>Previous: <a class="previous" href="https://ocramius.github.io/blog/doctrine-2-orm-zf2-tutorial/" title="A tutorial for Doctrine 2 ORM with Zend Framework 2"><span class="title">A tutorial for Doctrine 2 ORM with Zend Framework 2</span></a></li>
                                    </ul>
            </nav>
                </article>

        <script>
            if (typeof prettyPrint !== 'undefined') {
                $(prettyPrint);
            }
        </script>
                        </div>
                        <div class="span4 si debar"></div>
                   </div>
                </div>
            </div>

        </div>

        <script src="https://ocramius.github.io/js/shifty.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r66/three.min.js"></script>
        <script src="https://ocramius.github.io/components/jquery/jquery.min.js"></script>
        <script src="https://ocramius.github.io/components/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://ocramius.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script src="https://ocramius.github.io/js/classie.js"></script>
        <script src="https://ocramius.github.io/js/main4.js"></script>
        <script src="https://ocramius.github.io/js/three-js-object-loader.js"></script>
        <script src="https://ocramius.github.io/js/mario.js"></script>
        <script>mario($('#shield-container'), "https://ocramius.github.io/logo/mario");</script>
    </body>
</html>
