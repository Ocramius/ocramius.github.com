<!DOCTYPE html>
<html>
    <head>
        <title>ZF2, Zend Di and Controllers for fast SOA development</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/font/stylesheet.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/css/menu_bubble.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/normalize.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/demo.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/fontawesome.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/brands.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/solid.min.css" />
        <link href="https://ocramius.github.io/img/marco-pivetta-ocramius.gif" rel="shortcut icon"/>
        <link rel="stylesheet" href="https://ocramius.github.io/components/highlightjs/styles/github.css" />
        <link href="https://ocramius.github.io/css/style.css" rel="stylesheet" type="text/css" />
        <link rel="alternate" type="application/atom+xml" href="https://ocramius.github.io/atom.xml" title=" activity feed" />
    </head>
    <script src="https://ocramius.github.io/js/snap.svg-min.js"></script>
    <body>
        <div class="container">

            <div class='menu-wrap display'>
                <nav class="menu">
                    <div class="icon-list">
                        <a href="https://ocramius.github.io/"><i class="fa fa-solid fa-newspaper"></i><span>Latest Posts</span></a>
                        <a href="https://ocramius.github.io/blog"><i class="fa fa-solid fa-comment"></i><span>Archive</span></a>
                        <a href="https://ocramius.github.io/talks"><i class="fa fa-brands fa-youtube"></i><span>Presentations</span></a>
                        <a href="https://ocramius.github.io/joindin"><i class="fa fa-solid fa-star"></i><span>Talks</span></a>
                        <a href="https://ocramius.github.io/about"><i class="fa fa-solid fa-user"></i><span>About</span></a>

                                                <a href="https://mastodon.social/@ocramius" rel="me" title="https://mastodon.social/@ocramius mastodon profile" target="_blank"><i class="fa fa-brands fa-mastodon"></i><span>Mastodon</span></a>
                        
                                                <a href="https://github.com/Ocramius" rel="me" title="Ocramius github profile" target="_blank"><i class="fa fa-brands fa-github"></i><span>Github</span></a>
                                            </div>
                </nav>
                                <button class="close-button" id="close-button">Close Menu</button>
                                <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                        <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
                    </svg>
                </div>
            </div>

                        <button class="menu-button" id="open-button">Open Menu</button>
            
            <div class="content-wrap">
                <div class="content">
                    <div class="top left">
                        <p id="shield-container" class="logo-cont left" style="width: 200px; padding: 0; margin: 0; height: 200px;
"></p>
                                                <h2 class="left text-center">Marco Pivetta <span>(<a href="https://mastodon.social/@ocramius" target="blank">Ocramius</a>)</span></h2>
                                            </div>

                    <div class="clear"></div>
                    <p class="text-center remove-margin">
                        <img src="https://ocramius.github.io/img/separator.png" alt=""/>
                    </p>
                    <div class="row-fluid">
                        <div class="span12">
                                <article>
        <header>
            <h1>ZF2, Zend Di and Controllers for fast SOA development</h1>
        </header>
        <div>
            <h2>What is Zend\Di</h2>

<p>
    <code>Zend\Di</code> is a component introduced in early Beta versions of ZendFramework 2. Its job is to
    provide you with instances of a requested object populated with all the dependencies required for it to work
    correctly. If you're not familiar with it, you can read more about <code>Zend\Di</code> on the
    <a href="http://zf2.readthedocs.org/en/latest/modules/zend.di.introduction.html"
    title="Zend Framework 2 Zend\Di manual" target="_blank">ZF2 Zend\Di manual pages</a> and eventually try
    out <a href="https://github.com/ralphschindler/Zend_DI-Examples" title="examples about Zend\Di usage"
    target="_blank">Ralphschindler's examples</a>.
</p>

<hr/>

<h2>Why Zend\Di?</h2>

<p>
    <code>Zend\Di</code> has often been accused of being slow and complex to follow. It is if you don't have any
    experience with it. I will try to make a simple example of correct usage of it, directly taking my examples
    from how I develop with ZF2 daily. We will also cover the performance problem later in this blogpost.
</p>

<p>
    The reason why I use Zend\Di despite of its slowness is development time and clean
    <abbr title="Inversion of Control">IOC</abbr>. I am also quite experienced with it, so I learned to tame it
    and to take advantage of it over time, now it almost works as a linting tool for my code.
</p>

<p>
    When working with complex application structures with dozens of different services, repositories,
    controllers, caches and more you tend to do some mistakes (caused by lazyness) that will penalize you on the
    long run. Such mistakes are things like avoiding IOC to speed up development, or using setters for your hard
    dependencies because you don't know how to retrieve all dependencies at instantiation time. Even by
    following best practices, you will often be slowed down by having to maintain all the factories that are
    responsible for generating your controllers! Here's how I do it.
</p>

<hr/>

<h2>Let's get started!</h2>

<p>
    We will be developing a simple "greeting" action controller with a <code>helloAction</code>. It will consume
    a GreetingService, which produces greeting messages by fetching them from a given message container.
</p>

<p>
    First, let's get a skeleton application to work. Please mind that we're going to work within the Application
    module provided by ZendSkeletonApplication, but you should apply these concepts only for your own modules!
</p>

<pre><code class="sh">~$ git clone git://github.com/zendframework/ZendSkeletonApplication.git
~$ cd ZendSkeletonApplication
~$ ./composer.phar install
</code></pre>

<p>
    <span class="label label-info">For the lazy:</span> If you just prefer to look at the code and run it
    without having to reproduce my example, you can just look at the already modified skeleton at
    <a href="https://github.com/Ocramius/ZendSkeletonApplication/tree/demo/zf2-controllers-from-zend-di/module">
        Ocramius/ZendSkeletonApplication - branch demo/zf2-controllers-from-zend-di
    </a> and see what I did in the
    <a href="https://github.com/Ocramius/ZendSkeletonApplication/compare/master...demo;zf2-controllers-from-zend-di" target="_blank">diff</a>.
</p>

<p>
    You should now be able to browse to <code>http://localhost/path-to-skeleton-application/</code> and see the
    ZendSkeletonApplication default intro page.
</p>

<hr/>

<h2>The code</h2>

<p>
    Here are our service, greeting container and controller: that's the core of our application. I will already
    start with IOC, since I don't think I need to explain why I like it (nor am I qualified to do so!), and you
    already have read this far.
</p>

<h4>Greetings repository:</h4>

<p>
    A simple repository that fetches a random greeting message from an array.
</p>

<pre><code class="php">&lt;?php
// module/Application/src/Application/Repository/StaticGreetingRepository.php

namespace Application\Repository;

class StaticGreetingRepository
{
    protected $availableGreetings = array('Hi', 'Hello', 'Hey', 'What\'s up');

    /** @return string */
    public function getRandomGreeting()
    {
        return $this-&gt;availableGreetings[array_rand($this-&gt;availableGreetings)];
    }
}
</code></pre>

<h4>Greetings service (consumes repository):</h4>

<p>
    A service that assembles the entire message by picking a random greeting from a given repository and a
    provided name.
</p>

<pre><code class="php">&lt;?php
// module/Application/src/Application/Service/GreetingService.php

namespace Application\Service;

use Application\Repository\StaticGreetingRepository;

class GreetingService
{
    protected $repository;

    /** @var StaticGreetingRepository $repository */
    public function __construct(StaticGreetingRepository $repository)
    {
        $this-&gt;repository = $repository;
    }

    /**
     * this is an example method. It could perform operations such as discovering
     * the gender of the given name to customize the reply
     *
     * @var    string $name
     * @return string
     */
    public function greet($name)
    {
        return $this-&gt;repository-&gt;getRandomGreeting() . ' ' . $name . '!';
    }
}
</code></pre>

<h4>Greetings controller (consumes service):</h4>

<p>
    A controller we use to collect a <code>GET</code> request and return the message to the end user.
</p>

<pre><code class="php">&lt;?php
// module/Application/src/Application/Controller/GreetingController.php

namespace Application\Controller;

use Application\Service\GreetingService;
use Zend\Mvc\Controller\AbstractActionController;
use Zend\View\Model\ViewModel;

class GreetingController extends AbstractActionController
{
    /**
     * @var GreetingService
     */
    protected $greetingService;

    /**
     * @var GreetingService $greetingService
     */
    public function __construct(GreetingService $greetingService)
    {
        $this-&gt;greetingService = $greetingService;
    }

    public function helloAction()
    {
        $name = $this-&gt;getRequest()-&gt;getQuery('name', 'anonymous');

        return new ViewModel(array('greeting' =&gt; $this-&gt;greetingService-&gt;greet($name)));
    }
}
</code></pre>

<h4>And then a view to see some output:</h4>

<pre><code class="php">&lt;?php
// module/Application/view/application/greeting/hello.phtml
echo '&lt;h1&gt;' . $this-&gt;escapeHtml($this-&gt;greeting) . '&lt;/h1&gt;';
</code></pre>

<hr/>

<h2>Wiring it together</h2>

<p>
    To allow <code>Zend\Di</code> to work correctly with our application, we now need to allow our application
    to access the controller somehow. To do so, we have to define <code>config.di.allowed_controllers</code> and
    a route to allow access to our controller (and a couple of fixes required to inject inherited dependencies).
</p>

<pre><code class="php">&lt;?php

return array(
    'di' =&gt; array(
        'allowed_controllers' =&gt; array(
            // this config is required, otherwise the MVC won't even attempt to ask Di for the controller!
            'Application\Controller\GreetingController',
        ),

        'instance' =&gt; array(
            'preference' =&gt; array(
                // these allow injecting correct EventManager and ServiceManager
                // (taken from the main ServiceManager) into the controller,
                // because Di doesn't know how to retrieve abstract types. These
                // dependencies are inherited from Zend\Mvc\Controller\AbstractController
                'Zend\EventManager\EventManagerInterface' =&gt; 'EventManager',
                'Zend\ServiceManager\ServiceLocatorInterface' =&gt; 'ServiceManager',
            ),
        ),
    ),

    'router' =&gt; array(
        'routes' =&gt; array(
            'hello' =&gt; array(
                'type' =&gt; 'Zend\Mvc\Router\Http\Literal',
                'options' =&gt; array(
                    'route'    =&gt; '/hello',
                    'defaults' =&gt; array(
                        'controller' =&gt; 'Application\Controller\GreetingController',
                        'action'     =&gt; 'hello',
                    ),
                ),
            ),
        ),
    ),

    // remaining config
);
</code></pre>

<hr/>

<h2>Running it!</h2>

<p><strong>Seriously?</strong> Was that all? The answer is yes!</p>

<p>This will give you a basic example that renders a web page like the following:</p>

<p>
    <img
        style="box-shadow: 0 0 3px 5px #000"
        src="/img/posts/2012-08-6-zend-framework-2-controllers-and-dependency-injection-with-zend-di/zend-di-controller-sample-preview.png"
        alt="Preview of the output of the Zend\Di based Mvc SOA example"
    />
</p>

<hr/>

<h2>Considerations</h2>

<p>
    Ok, what did just happen? <code>Zend\Di</code> recursively discovered all hard dependencies and built a
    fully operational controller for us! And that with very clean and simple code.
</p>

<p>
    Some may argue that this is "dark magic". It is not, it is just another way of wiring things together,
    and I am not suggesting it for your production environment nor as a definitive solution to solve all your
    dependency injection problems: just for development.
</p>

<hr/>

<h2>Performance issues</h2>

<p><span class="label label-important">Careful!</span> Performance impact of using <code>Zend\Di</code> over a
    ServiceManager factory is around 15%, and that overhead increases with the number and recursion of the
    dependencies.
    Enabling complex Di based modules such as <a href="https://github.com/Ocramius/ZfPhpcrOdm" target="_blank">
    ocramius/zf-phpcr-odm</a> may affect performance by an order of 200% or more!
</p>

<p>
    But that is perfectly fine in a development environment, since we want to get working as fast as possible
    and keeping our code clean and simple. This is simply not possible in a context where dependencies continue
    to change because of architectural changes in your application. You must be free to do your decisions before
    freezing everything into a Service Factory!
</p>

<p>
    If you want to remove the performance overhead and still keep the benefits of using Zend\Di, you can try my
    <a href="https://github.com/Ocramius/OcraDiCompiler" target="_blank">ocramius/ocra-di-compiler</a>, which
    simply does the work you should do when you want to compile your Di container into a series of service
    factories/PHP closures.
</p>

<p>
    Otherwise, simply do following in your configuration once you are sure your dependencies won't change much:
</p>

<pre><code class="php">&lt;?php

return array(
    'controllers' =&gt; array(
        'factories' =&gt; array(
            'Application\Controller\GreetingController' =&gt; function($sm) {
                return new \Application\Controller\GreetingController(
                    new \Application\Service\GreetingService(
                       new \Application\Repository\StaticGreetingRepository()
                    ),
                );
            },
        ),
    ),

    // remaining config
);
</code></pre>

<p>
    This basically removes all the overhead, but also removes the flexibility of <code>Zend\Di</code>, since
    you won't be able to swap the implementation of either the <code>GreetingService</code> or the
    <code>StaticGreetingRepository</code> used to dispatch your request. I personally see this as one of the
    last steps before shipping your code for production, since OcraDiCompiler can handle these operations for
    you.
</p>

<p>
   <span class="label label-info">Note:</span>  Please also note that in this example, all dependency injection
     are based on type hints of concret  implementations. I cleaned up my code and invite you to check
    <a href="https://github.com/Ocramius/ZendSkeletonApplication/tree/demo/zf2-controllers-from-zend-di-cleanup/module" target="_blank">
        Ocramius/ZendSkeletonApplication - demo/zf2-controllers-from-zend-di-cleanup
    </a> and see what I did in the
    <a href="https://github.com/Ocramius/ZendSkeletonApplication/compare/demo;zf2-controllers-from-zend-di...demo;zf2-controllers-from-zend-di-cleanup" target="_blank">diff</a>.
    In this case I simply exchanged the type hints with abstract types (which allow more flexibility) and taught
    <code>Zend\Di</code> how to handle injections for them.
</p>

<p>
    To check how I improved performance using <code>ocramius/ocra-di-compiler</code>, please refer to branch
    <a href="https://github.com/Ocramius/ZendSkeletonApplication/tree/demo/zf2-controllers-from-zend-di-with-compiled-di/module" target="_blank">
        Ocramius/ZendSkeletonApplication - demo/zf2-controllers-from-zend-di-with-compiled-di
    </a> and to the related <a href="https://github.com/Ocramius/ZendSkeletonApplication/compare/demo;zf2-controllers-from-zend-di-cleanup...demo;zf2-controllers-from-zend-di-with-compiled-di" target="_blank">diff</a>.
</p>

<hr/>

<h2>Conclusions</h2>

<p>
    As I've stated from the beginning, this is a development process, not something you want to have happening
    at runtime at every request. <code>Zend\Di</code> is a very powerful tool, especially when it comes to
    testing, exchenging deeply nested dependencies and keeping IOC as clean as possible. Use it wisely and it
    may become your best ally while handling your usual impossible customer, but maybe this time without
    screwing up as much code as usual ;-)
</p>

        </div>
                            <p class="tags">
            Tags:
                        <a href="https://ocramius.github.io/blog/tags/zend">zend</a>,                         <a href="https://ocramius.github.io/blog/tags/zendframework">zendframework</a>,                         <a href="https://ocramius.github.io/blog/tags/dependency">dependency</a>,                         <a href="https://ocramius.github.io/blog/tags/injection">injection</a>,                         <a href="https://ocramius.github.io/blog/tags/di">di</a>,                         <a href="https://ocramius.github.io/blog/tags/dic">dic</a>,                         <a href="https://ocramius.github.io/blog/tags/soa">soa</a>,                         <a href="https://ocramius.github.io/blog/tags/mvc">mvc</a>                        </p>
        
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="https://ocramius.github.io/blog/a-simple-doctrine-2-orm-tutorial/" title="A Doctrine 2 ORM Tutorial for beginners"><span class="title">A Doctrine 2 ORM Tutorial for beginners</span></a></li>
                                                                <li>Previous: <a class="previous" href="https://ocramius.github.io/blog/moving-my-blog-to-jekyll/" title="Moving my blog to Jekyll and Github pages"><span class="title">Moving my blog to Jekyll and Github pages</span></a></li>
                                    </ul>
            </nav>
                </article>

        <script>
            if (typeof prettyPrint !== 'undefined') {
                $(prettyPrint);
            }
        </script>
                        </div>
                        <div class="span4 si debar"></div>
                   </div>
                </div>
            </div>

        </div>

        <script src="https://ocramius.github.io/js/shifty.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r66/three.min.js"></script>
        <script src="https://ocramius.github.io/components/jquery/jquery.min.js"></script>
        <script src="https://ocramius.github.io/components/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://ocramius.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script src="https://ocramius.github.io/js/classie.js"></script>
        <script src="https://ocramius.github.io/js/main4.js"></script>
        <script src="https://ocramius.github.io/js/three-js-object-loader.js"></script>
        <script src="https://ocramius.github.io/js/mario.js"></script>
        <script>mario($('#shield-container'), "https://ocramius.github.io/logo/mario");</script>
    </body>
</html>
