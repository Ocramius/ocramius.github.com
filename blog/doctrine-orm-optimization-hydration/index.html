<!DOCTYPE html>
<html>
    <head>
        <title>Doctrine ORM Hydration Performance Optimization</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="description" content="Hydration is the most expensive operation performed by Doctrine ORM: how do we prevent it from killing our applications?">
        
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/font/stylesheet.css" rel="stylesheet" type="text/css" />
        <link href="https://ocramius.github.io/css/menu_bubble.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/normalize.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/css/demo.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/fontawesome.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/brands.min.css" />
        <link rel="stylesheet" type="text/css" href="https://ocramius.github.io/font/fontawesome-free-6.7.2-web/css/solid.min.css" />
        <link href="https://ocramius.github.io/img/marco-pivetta-ocramius.gif" rel="shortcut icon"/>
        <link rel="stylesheet" href="https://ocramius.github.io/components/highlightjs/styles/github.css" />
        <link href="https://ocramius.github.io/css/style.css" rel="stylesheet" type="text/css" />
        <link rel="alternate" type="application/atom+xml" href="https://ocramius.github.io/atom.xml" title=" activity feed" />
    </head>
    <script src="https://ocramius.github.io/js/snap.svg-min.js"></script>
    <body>
        <div class="container">

            <div class='menu-wrap display'>
                <nav class="menu">
                    <div class="icon-list">
                        <a href="https://ocramius.github.io/"><i class="fa fa-solid fa-newspaper"></i><span>Latest Posts</span></a>
                        <a href="https://ocramius.github.io/blog"><i class="fa fa-solid fa-comment"></i><span>Archive</span></a>
                        <a href="https://ocramius.github.io/talks"><i class="fa fa-brands fa-youtube"></i><span>Presentations</span></a>
                        <a href="https://ocramius.github.io/joindin"><i class="fa fa-solid fa-star"></i><span>Talks</span></a>
                        <a href="https://ocramius.github.io/about"><i class="fa fa-solid fa-user"></i><span>About</span></a>

                                                <a href="https://mastodon.social/@ocramius" rel="me" title="https://mastodon.social/@ocramius mastodon profile" target="_blank"><i class="fa fa-brands fa-mastodon"></i><span>Mastodon</span></a>
                        
                                                <a href="https://github.com/Ocramius" rel="me" title="Ocramius github profile" target="_blank"><i class="fa fa-brands fa-github"></i><span>Github</span></a>
                                            </div>
                </nav>
                                <button class="close-button" id="close-button">Close Menu</button>
                                <div class="morph-shape" id="morph-shape" data-morph-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
                        <path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
                    </svg>
                </div>
            </div>

                        <button class="menu-button" id="open-button">Open Menu</button>
            
            <div class="content-wrap">
                <div class="content">
                    <div class="top left">
                        <p id="shield-container" class="logo-cont left" style="width: 200px; padding: 0; margin: 0; height: 200px;
"></p>
                                                <h2 class="left text-center">Marco Pivetta <span>(<a href="https://mastodon.social/@ocramius" target="blank">Ocramius</a>)</span></h2>
                                            </div>

                    <div class="clear"></div>
                    <p class="text-center remove-margin">
                        <img src="https://ocramius.github.io/img/separator.png" alt=""/>
                    </p>
                    <div class="row-fluid">
                        <div class="span12">
                                <article>
        <header>
            <time datetime="2015-4-13">2015-4-13</time>
            <h1>Doctrine ORM Hydration Performance Optimization</h1>
        </header>
        <div>
            <p class="alert alert-warning">
    <span class="label label-warning">PRE-REQUISITE:</span>
    Please note that this article explains complexity in internal ORM operations with the <strong>Big-O</strong>
    notation. Consider reading
    <a href="http://stackoverflow.com/questions/487258/plain-english-explanation-of-big-o" target="_blank">this article</a>, 
    if you are not familiar with the <strong>Big-O</strong> syntax.
</p>

<h2>What is hydration?</h2>

<p>
    Doctrine ORM, like most ORMs, is performing a process called <strong>Hydration</strong> when converting database
    results into objects.
</p>

<p>
    This process usually involves reading a record from a database result and then converting the column values
    into an object's properties.
</p>

<p>
    Here is a little pseudo-code snippet that shows what a mapper is actually doing under the hood:
</p>

<pre><code class="php">&lt;?php

$results          = [];
$reflectionFields = $mappingInformation-&gt;reflectionFields();

foreach ($resultSet-&gt;fetchRow() as $row) {
    $object = new $mappedClassName;

    foreach ($reflectionFields as $column =&gt; $reflectionField) {
        $reflectionField-&gt;setValue($object, $row[$column]);
    }

    $results[] = $object;
}

return $results;
</code></pre>

<p>
    That's a very basic example, but this gives you an idea of what an ORM is doing for you.
</p>

<p class="alert alert-success">
    As you can see, this is an <code>O(N)</code> operation (assuming a constant number of reflection fields).
</p>

<p>
    There are multiple ways to speed up this particular process, but we can only remove constant overhead from
    it, and not actually reduce it to something more efficient.
</p>

<h2>When is hydration expensive?</h2>

<p>
    Hydration starts to become expensive with complex resultsets.
</p>

<p>
    Consider the following SQL query:
</p>

<pre><code class="sql">SELECT
    u.id       AS userId,
    u.username AS userUsername,
    s.id       AS socialAccountId,
    s.username AS socialAccountUsername,
    s.type     AS socialAccountType
FROM
    user u
LEFT JOIN
    socialAccount s
        ON s.userId = u.id
</code></pre>

<p>
    Assuming that the relation from <code>user</code> to <code>socialAccount</code> is a <code>one-to-many</code>,
    this query retrieves all the social accounts for all the users in our application
</p>

<p>
    A resultset may be as follows:
</p>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>userId</th>
            <th>userUsername</th>
            <th>socialAccountId</th>
            <th>socialAccountUsername</th>
            <th>socialAccountType</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>20</td>
            <td>ocramius</td>
            <td>Facebook</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>21</td>
            <td>@ocramius</td>
            <td>Twitter</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>22</td>
            <td>ocramiusaethril</td>
            <td>Last.fm</td>
        </tr>
        <tr>
            <td>2</td>
            <td>grandpa@example.com</td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
        </tr>
        <tr>
            <td>3</td>
            <td>grandma@example.com</td>
            <td>85</td>
            <td>awesomegrandma9917</td>
            <td>Facebook</td>
        </tr>
    </tbody>
</table>

<p>
    As you can see, we are now joining 2 tables in the results, and the ORM has to perform more complicated operations:
</p>

<dl class="dl-horizontal">
    <dt>
        Hydrate <strong>1</strong>
    </dt>
    <dd>
        <code>User</code> object for
        <i>ocramius@gmail.com</i>
    </dd>
    <dt>
        Hydrate <strong>3</strong>
    </dt>
    <dd>
        <code>SocialAccount</code> 
        instances into 
        <code>User#$socialAccounts</code> 
        for 
        <i>ocramius@gmail.com</i>,
        while skipping re-hydrating
        <code>User</code>
        <i>ocramius@gmail.com</i>
    </dd>
    <dt>
        Hydrate <strong>1</strong>
    </dt>
    <dd>
        <code>User</code>
        object for
        <i>grandpa@example.com</i>
    </dd>
    <dt>
        Skip hydrating
    </dt>
    <dd>
        <code>User#$socialAccounts</code>
        for
        <i>grandpa@example.com</i>,
        as no social accounts are associated
    </dd>
    <dt>
        Hydrate <strong>1</strong>
    </dt>
    <dd>
        <code>User</code>
        object for
        <i>grandma@example.com</i>
    </dd>
    <dt>
        Hydrate <strong>1</strong>
    </dt>
    <dd>
        <code>SocialAccount</code>
        instance into
        <code>User#$socialAccounts</code>
        for
        <i>grandma@example.com</i>
    </dd>
</dl>

<p class="alert alert-info">
    <span class="label label-info">DOCS</span>
    This operation is what is done by Doctrine ORM when you use the
    <abbr title="Doctrine Query Language">DQL</abbr>
    <a href="http://docs.doctrine-project.org/en/latest/reference/dql-doctrine-query-language.html#joins" target="_blank">
        Fetch Joins
    </a>
    feature.
</p>

<p>
    Fetch joins are a very efficient way to hydrate multiple records without resorting to multiple queries, but there
    are two performance issues with this approach (both not being covered by this article):
</p>

<ul>
    <li>
        Empty records require some useless looping inside the ORM internals (see <i>grandpa@example.com</i>'s
        social account). This is a quick operation, but we can't simply ignore those records upfront.
    </li>
    <li>
        If multiple duplicated records are being joined (happens a lot in <code>many-to-many</code> associations),
        then we want to de-duplicate records by keeping a temporary in-memory identifier map.
    </li>
</ul>

<p class="alert alert-danger">
    Additionally, our operation starts to become more complicated, as it is now <code>O(n * m)</code>, with
    <code>n</code> and <code>m</code> being the records in the <code>user</code> and the <code>socialAccount</code>
    tables.
</p>

<p>
    What the ORM is actually doing here is <strong>normalizing</strong> data that was fetched in a de-normalized
    resultset, and that is going through your CPU and your memory.
</p>

<h2>Bringing hydration cost to an extreme</h2>

<p>
    The process of hydration becomes extremely expensive when more than <strong>2</strong> <code>LEFT JOIN</code>
    operations clauses are part of our queries:
</p>

<pre><code class="sql">SELECT
    u.id         AS userId,
    u.username   AS userUsername,
    sa.id        AS socialAccountId,
    sa.username  AS socialAccountUsername,
    sa.type      AS socialAccountType,
    s.id         AS sessionId,
    s.expiresOn  AS sessionExpiresOn,
FROM
    user u
LEFT JOIN
    socialAccount sa
        ON sa.userId = u.id
LEFT JOIN
    session s
        ON s.userId = u.id
</code></pre>

<p>
    This kind of query produces a much larger resultset, and the results are duplicated by a lot:
</p>

<table class="table table-bordered table-striped" style="max-width: 500px">
    <thead>
        <tr>
            <th>userId</th>
            <th>user Username</th>
            <th>social Account Id</th>
            <th>social Account Username</th>
            <th>social Account Type</th>
            <th>session Id</th>
            <th>session Expires On</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>20</td>
            <td>ocramius</td>
            <td>Facebook</td>
            <td>ocramius-macbook</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>21</td>
            <td>@ocramius</td>
            <td>Twitter</td>
            <td>ocramius-macbook</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>22</td>
            <td>ocramiusaethril</td>
            <td>Last.fm</td>
            <td>ocramius-macbook</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>20</td>
            <td>ocramius</td>
            <td>Facebook</td>
            <td>ocramius-android</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>21</td>
            <td>@ocramius</td>
            <td>Twitter</td>
            <td>ocramius-android</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>1</td>
            <td>ocramius@gmail.com</td>
            <td>22</td>
            <td>ocramiusaethril</td>
            <td>Last.fm</td>
            <td>ocramius-android</td>
            <td>2015-04-20 22:08:56</td>
        </tr>
        <tr>
            <td>2</td>
            <td>grandpa@example.com</td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
            <td><code>NULL</code></td>
        </tr>
        <tr>
            <td>3</td>
            <td>grandma@example.com</td>
            <td>85</td>
            <td>awesomegrandma</td>
            <td>Facebook</td>
            <td>home-pc</td>
            <td>2015-04-15 10:05:31</td>
        </tr>
    </tbody>
</table>

<p>
    If you try to re-normalize this resultset, you can actually see how many useless de-duplication operation
    have to happen.
</p>

<p>
    That is because the <code>User</code> <i>ocramius@gmail.com</i> has multiple active sessions on
    multiple devices, as well as multiple social accounts.
</p>

<p class="alert alert-danger">
    <span class="label label-warning">SLOW!</span>
    The hydration operations on this resultset are <code>O(n * m * q)</code>, which I'm going to simply
    generalize as <code>O(n ^ m)</code>, with <code>n</code> being the amount of results, and <code>m</code>
    being the amount of joined tables.
</p>

<p>
    Here is a graphical representation of <code>O(n ^ m)</code>:
</p>

<p>
    <img
        src="/img/posts/2015-04-13-doctrine-orm-optimization-hydration/boy-that-escalated-quickly.jpg"
        alt="Boy, that escalated quickly"
    />
</p>

<p>
    Yes, it is bad.
</p>

<h2>How to avoid <code>O(n ^ m)</code> hydration?</h2>

<p>
    <code>O(n ^ m)</code> can be avoided with some very simple, yet effective approaches.
</p>

<blockquote cite="me">
    No, it's not <em>"don't use an ORM"</em>, you muppet.
</blockquote>

<h3>Avoiding <code>one-to-many</code> and <code>many-to-many</code> associations</h3>

<p>
    Collection valued associations are as useful as problematic, as you never know how much data you are
    going to load.
</p>

<p>
    Unless you use <code>fetch="EXTRA_LAZY"</code> and <code>Doctrine\Common\Collections\Collection#slice()</code>
    wisely, you will probably make your app crash if you initialize a very large collection of associated objects.
</p>

<p>
    Therefore, the simplest yet most limiting advice is to avoid collection-valued associations whenever
    they are not strictly necessary.
</p>

<p>
    Additionally, reduce the amount of bi-directional associations to the strict necessary.
</p>

<p>
    After all, code that is not required should not be written in first place.
</p>

<h3>Multi-step hydration</h3>

<p>
    The second approach is simpler, and allows us to exploit how the ORM's <code>UnitOfWork</code> is working
    internally.
</p>

<p>
    In fact, we can simply split hydration for different associations into different queries, or multiple steps:
</p>

<pre><code class="sql">SELECT
    u.id         AS userId,
    u.username   AS userUsername,
    s.id         AS socialAccountId,
    s.username   AS socialAccountUsername,
    s.type       AS socialAccountType
FROM
    user u
LEFT JOIN
    socialAccount s
        ON s.userId = u.id
</code></pre>

<p>
    We already know this query: hydration for it is <code>O(n * m)</code>, but that's the best we can do,
    regardless of how we code it.
</p>

<pre><code class="sql">SELECT
    u.id        AS userId,
    u.username  AS userUsername,
    s.id        AS sessionId,
    s.expiresOn AS sessionExpiresOn,
FROM
    user u
LEFT JOIN
    session s
        ON s.userId = u.id
</code></pre>

<p>
    This query is another <code>O(n * m)</code> hydration one, but we are now only loading the user sessions
    in the resultsets, avoiding duplicate results overall.
</p>

<p>
    By re-fetching the same users, we are telling the ORM to re-hydrate those objects (which are now in memory,
    stored in the <code>UnitOfWork</code>): that fills the <code>User#$sessions</code> collections.
</p>

<p>
    Also, please note that we could have used a <code>JOIN</code> instead of a <code>LEFT JOIN</code>, but that
    would have triggered lazy-loading on the sessions for the <i>grandpa@example.com</i> <code>User</code>
</p>

<p>
    Additionally, we could also skip the <i>userUsername</i> field from the results, as it already is in memory
    and well known.
</p>

<p class="alert alert-success">
    <span class="label label-success">SOLUTION:</span>
    We now reduced the hydration complexity from <code>O(n ^ m)</code> to <code>O(n * m * k)</code>, with
    <code>n</code> being the amount of <code>User</code> instances, <code>m</code> being the amount of associated
    <code>to-many</code> results, and <code>k</code> being the amount of associations that we want to hydrate.
</p>

<h3>Coding multi-step hydration in Doctrine ORM</h3>

<p>
    Let's get more specific and code the various queries represented above in
    <abbr title="Doctrine Query Language">DQL</abbr>.
</p>

<p>
    Here is the <code>O(n ^ m)</code> query (in this case, <code>O(n ^ 3)</code>):
</p>

<pre><code class="php">return $entityManager
    -&gt;createQuery('
        SELECT
            user, socialAccounts, sessions 
        FROM
            User user
        LEFT JOIN
            user.socialAccounts socialAccounts
        LEFT JOIN
            user.sessions sessions
    ')
    -&gt;getResult();
</code></pre>

<p>
    This is how you'd code the multi-step hydration approach:
</p>

<pre><code class="php">$users = $entityManager
    -&gt;createQuery('
        SELECT
            user, socialAccounts
        FROM
            User user
        LEFT JOIN
            user.socialAccounts socialAccounts
    ')
    -&gt;getResult();

$entityManager
    -&gt;createQuery('
        SELECT PARTIAL
            user.{id}, sessions
        FROM
            User user
        LEFT JOIN
            user.sessions sessions
    ')
    -&gt;getResult(); // result is discarded (this is just re-hydrating the collections)

return $users;
</code></pre>

<p>
    I'd also add that this is the only legitimate use-case for partial hydration that I ever
    had, but it's a personal opinion/feeling.
</p>

<h2>Other alternatives (science fiction)</h2>

<p>
    As you may have noticed, all this overhead is caused by normalizing de-normalized data coming
    from the DB.
</p>

<p>
    Other solutions that we may work on in the future include:
</p>

<ul>
    <li>
        Generating hydrator code - solves constant overhead issues, performs better with
        <abbr title="Just In Time">JIT</abbr> engines such as <abbr title="HipHop VM">HHVM</abbr>
    </li>
    <li>
        Leveraging the capabilities of powerful engines such as PostgreSQL, which comes with JSON
        support (since version 9.4), and would allow us to normalize the fetched data to some extent
    </li>
    <li>
        Generate more complex SQL, creating an own output format that is "hydrator-friendly" (re-inventing
        the wheel here seems like a bad idea)
    </li>
</ul>

<h2>Research material</h2>

<p>
    Just so you stop thinking that I pulled out all these thought out of thin air, here is a repository
    with actual code examples that you can run, measure, compare and patch yourself:
</p>

<h4>
    <a href="https://github.com/Ocramius/Doctrine2StepHydration" target="_blank">
        https://github.com/Ocramius/Doctrine2StepHydration
    </a>
</h4>

<p>
    Give it a spin and see the results for yourself!
</p>

        </div>
                            <p class="tags">
            Tags:
                        <a href="https://ocramius.github.io/blog/tags/php">php</a>,                         <a href="https://ocramius.github.io/blog/tags/doctrine">doctrine</a>,                         <a href="https://ocramius.github.io/blog/tags/orm">orm</a>,                         <a href="https://ocramius.github.io/blog/tags/hydration">hydration</a>,                         <a href="https://ocramius.github.io/blog/tags/performance">performance</a>,                         <a href="https://ocramius.github.io/blog/tags/speed">speed</a>                        </p>
        
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="https://ocramius.github.io/blog/proxy-manager-2-0-0-release/" title="ProxyManager 2.0.0 release and expected 2.x lifetime"><span class="title">ProxyManager 2.0.0 release and expected 2.x lifetime</span></a></li>
                                                                <li>Previous: <a class="previous" href="https://ocramius.github.io/blog/when-to-declare-classes-final/" title="When to declare classes final"><span class="title">When to declare classes final</span></a></li>
                                    </ul>
            </nav>
                </article>

        <script>
            if (typeof prettyPrint !== 'undefined') {
                $(prettyPrint);
            }
        </script>
                        </div>
                        <div class="span4 si debar"></div>
                   </div>
                </div>
            </div>

        </div>

        <script src="https://ocramius.github.io/js/shifty.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r66/three.min.js"></script>
        <script src="https://ocramius.github.io/components/jquery/jquery.min.js"></script>
        <script src="https://ocramius.github.io/components/bootstrap/js/bootstrap.min.js"></script>
        <script src="https://ocramius.github.io/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script src="https://ocramius.github.io/js/classie.js"></script>
        <script src="https://ocramius.github.io/js/main4.js"></script>
        <script src="https://ocramius.github.io/js/three-js-object-loader.js"></script>
        <script src="https://ocramius.github.io/js/mario.js"></script>
        <script>mario($('#shield-container'), "https://ocramius.github.io/logo/mario");</script>
    </body>
</html>
